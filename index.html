<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Code Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        blob: "blob 7s infinite",
                    },
                    keyframes: {
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" },
                        },
                    },
                }
            }
        }
    </script>
    <style>
        /* Minimalist Spinner */
        .spinner {
            width: 1em;
            height: 1em;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: #000;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Elegant Toast */
        .toast-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            backdrop-filter: blur(8px);
            padding: 12px 24px;
            border-radius: 9999px;
            font-size: 0.875rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        /* Smooth Scroll for table */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Gradient mask for history list fade out */
        .mask-gradient {
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col items-center justify-center p-6 selection:bg-black selection:text-white">

    <div class="fixed inset-0 z-[-1] opacity-60">
        <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <main class="w-full max-w-md bg-white/80 backdrop-blur-xl rounded-[2rem] shadow-[0_20px_60px_-15px_rgba(0,0,0,0.1)] border border-white/50 overflow-hidden transition-all duration-500">
        
        <div class="pt-10 pb-2 text-center">
            <h1 class="text-xs font-bold tracking-[0.2em] uppercase text-slate-400 mb-1">Pass Generator</h1>
            <div class="flex items-center justify-center space-x-2">
                <span id="countText" class="text-[10px] font-medium px-2 py-1 bg-slate-100 rounded-full text-slate-500">Connecting...</span>
            </div>
            <div id="maxMessage" class="hidden text-xs font-bold text-red-500 mt-2">Max Limit Reached</div>
        </div>

        <div class="flex flex-col items-center justify-center py-8">
            <div id="bigCode" class="text-7xl font-mono font-medium tracking-tighter text-slate-900 select-all cursor-pointer transition-transform hover:scale-105 active:scale-95 duration-200" title="Click to copy" onclick="document.getElementById('copyBtn').click()">
                ....
            </div>
        </div>

        <div class="px-8 pb-10 space-y-4">
            <button id="generateBtn" class="w-full h-14 bg-black hover:bg-slate-800 disabled:bg-slate-200 disabled:text-slate-400 text-white font-medium rounded-2xl text-lg transition-all duration-200 shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 disabled:shadow-none disabled:translate-y-0 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled>
                Generate Code
            </button>

            <div class="grid grid-cols-2 gap-3">
                <button id="copyBtn" class="h-12 border border-slate-200 hover:border-slate-300 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-medium transition-colors flex items-center justify-center gap-2">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    Copy
                </button>
                <button id="exportBtn" class="h-12 border border-slate-200 hover:border-slate-300 hover:bg-slate-50 text-slate-600 rounded-xl text-sm font-medium transition-colors flex items-center justify-center gap-2">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Export
                </button>
            </div>
        </div>

        <div class="bg-slate-50 border-t border-slate-100 p-6">
            <h2 class="text-[10px] font-bold tracking-widest uppercase text-slate-400 mb-3">Recent History</h2>
            <div class="h-24 overflow-y-auto scrollbar-hide mask-gradient">
                <table id="codesTable" class="w-full">
                    <tbody id="codesBody" class="flex flex-col gap-1">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="mt-6 text-slate-400 text-xs font-medium">
        Secure Event System
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script type="module">
        // ====================================================================
        // FIREBASE INITIALIZATION
        // ====================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCEs7B0vZS1riiJBRqpM84ljXVDePJsgMw",
            authDomain: "code-gen-vk.firebaseapp.com",
            projectId: "code-gen-vk",
            storageBucket: "code-gen-vk.firebasestorage.app",
            messagingSenderId: "75440750107",
            appId: "1:75440750107:web:d561f76027aeb3f1d242be",
            measurementId: "G-58YMCLPJ7Q"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const CODE_DOC_REF = doc(db, "uniqueCodes", "generatedCodes"); 

        // ====================================================================
        // CLIENT-SIDE LOGIC
        // ====================================================================

        const generateBtn = document.getElementById("generateBtn");
        const copyBtn = document.getElementById("copyBtn");
        const exportBtn = document.getElementById("exportBtn");
        const bigCode = document.getElementById("bigCode");
        const codesBody = document.getElementById("codesBody");
        const countText = document.getElementById("countText");
        const maxMessage = document.getElementById("maxMessage");

        const CODE_LENGTH = 4;
        const CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        const TOTAL_POSSIBLE_CODES = Math.pow(CHARS.length, CODE_LENGTH);
        const COOLDOWN_SECONDS = 3;
        
        const usedCodes = new Set();
        let latestCode = "—";
        let isMaxReached = false;
        let isInitialLoad = true;
        let isCooldown = false;

        // --- FIREBASE OPS ---

        async function loadCodesFromFirestore() {
            try {
                // Initial silent spinner
                generateBtn.innerHTML = '<span class="spinner"></span>';
                
                const docSnap = await getDoc(CODE_DOC_REF);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const codesArray = data.codes || [];
                    
                    codesArray.forEach(code => usedCodes.add(code));
                    Array.from(usedCodes).reverse().forEach(code => renderNewCode(code));
                    
                    if (usedCodes.size > 0) {
                        latestCode = Array.from(usedCodes).pop();
                        bigCode.textContent = latestCode;
                    } else {
                        bigCode.textContent = "READY";
                    }
                    showToast(`Synced ${usedCodes.size} codes`);
                } else {
                    await setDoc(CODE_DOC_REF, { codes: [] });
                    bigCode.textContent = "READY";
                }
            } catch (error) {
                console.error("Error", error);
                showToast("Offline Mode / Error", 'error');
                bigCode.textContent = "ERR";
            }
            
            isInitialLoad = false;
            updateCountText();
            setLoadingState(false);
        }

        async function saveNewCodeToFirestore(newCode) {
            try {
                await updateDoc(CODE_DOC_REF, {
                    codes: Array.from(usedCodes) 
                });
            } catch (error) {
                console.error("Error saving", error);
                showToast(`Saved locally, but cloud sync failed`, 'error');
            }
        }

        // --- UI UTILS ---

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return; 
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            void toast.offsetWidth;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function copyToClipboard() {
            const code = latestCode.trim();
            if (code === '—' || code === 'READY' || !code || isInitialLoad) return;
            
            const tempInput = document.createElement('textarea');
            tempInput.value = code;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showToast(`Copied`);
            } catch (err) {
                showToast('Copy failed', 'error');
            }
            document.body.removeChild(tempInput);
        }

        function setLoadingState(isLoading) {
            if (isLoading || isInitialLoad) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<span class="spinner"></span>';
                bigCode.style.opacity = "0.5";
            } else if (isCooldown) {
                // Cooldown state is handled by the timer function, 
                // but this ensures we don't accidentally override it
                generateBtn.disabled = true;
                bigCode.style.opacity = "1";
            } else {
                generateBtn.disabled = isMaxReached;
                generateBtn.innerHTML = isMaxReached ? `Limit Reached` : `Generate New Code`;
                bigCode.style.opacity = "1";
                if (bigCode.textContent === 'Generating...') bigCode.textContent = latestCode;
            }
        }

        function startCooldown() {
            isCooldown = true;
            let secondsLeft = COOLDOWN_SECONDS;
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = `Wait ${secondsLeft}s`;
            
            const timer = setInterval(() => {
                secondsLeft--;
                if (secondsLeft <= 0) {
                    clearInterval(timer);
                    isCooldown = false;
                    setLoadingState(false); // Reset to "Generate New Code"
                } else {
                    generateBtn.innerHTML = `Wait ${secondsLeft}s`;
                }
            }, 1000);
        }

        function updateCountText() {
            countText.textContent = `${usedCodes.size} Generated`;
            if (usedCodes.size >= TOTAL_POSSIBLE_CODES) setMaxReachedState();
            else if (!isInitialLoad && !isCooldown) {
                isMaxReached = false;
                generateBtn.disabled = false;
                maxMessage.classList.add('hidden');
            }
        }

        function setMaxReachedState() {
            isMaxReached = true;
            generateBtn.disabled = true;
            generateBtn.innerHTML = `Limit Reached`;
            maxMessage.classList.remove('hidden');
        }

        // --- LOGIC ---

        function randomCode() {
            let out = "";
            for (let i = 0; i < CODE_LENGTH; i++) {
                out += CHARS.charAt(Math.floor(Math.random() * CHARS.length));
            }
            return out;
        }

        function generateUniqueCode(retries = 10) {
            if (usedCodes.size >= TOTAL_POSSIBLE_CODES) return null;
            for (let i = 0; i < retries; i++) {
                const candidate = randomCode();
                if (!usedCodes.has(candidate)) return candidate;
            }
            return null; 
        }

        async function onGenerateClick() {
            // Guard clause if cooldown is active
            if (isCooldown || isMaxReached) return;

            setLoadingState(true);

            // Artificial delay for UX feel
            await new Promise(r => setTimeout(r, 400));

            const newCode = generateUniqueCode();

            if (newCode) {
                usedCodes.add(newCode);
                latestCode = newCode;
                bigCode.textContent = newCode;
                renderNewCode(newCode);
                updateCountText();
                saveNewCodeToFirestore(newCode); // No await, let it save in background
                
                // Start Cooldown immediately after generation
                startCooldown();
            } else {
                setMaxReachedState();
                bigCode.textContent = "FULL";
                setLoadingState(false);
            }
        }

        function renderNewCode(code) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.className = "py-1.5 px-0 text-xs font-mono text-slate-500 border-b border-slate-100 flex justify-between";
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            td.innerHTML = `<span class="text-slate-800 font-bold">${code}</span> <span class="text-slate-300">${time}</span>`;
            tr.appendChild(td);

            if (codesBody.firstChild) {
                codesBody.insertBefore(tr, codesBody.firstChild);
            } else {
                codesBody.appendChild(tr);
            }
        }

        function exportCSV() {
            if (usedCodes.size === 0) { showToast("Nothing to export"); return; }
            const header = "Code\n";
            const rows = Array.from(usedCodes).reverse().join("\n"); 
            const blob = new Blob([header + rows], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `codes_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function init() {
            generateBtn.addEventListener("click", onGenerateClick);
            copyBtn.addEventListener("click", copyToClipboard);
            exportBtn.addEventListener("click", exportCSV);
            loadCodesFromFirestore();
        }

        init();
    </script>
</body>
</html>

